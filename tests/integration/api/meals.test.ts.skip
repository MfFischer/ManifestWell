/**
 * Integration Tests - Meals API
 * Tests authentication, authorization, validation, and CSRF protection
 */

import { describe, it, expect, beforeEach } from 'vitest'
import { db } from '@/lib/db'
import { generateCsrfToken } from '@/middleware/csrf'

// Mock request helper
function createRequest(
  method: string,
  url: string,
  options: {
    headers?: Record<string, string>
    body?: any
    userId?: string
  } = {}
): Request {
  const headers = new Headers(options.headers || {})

  if (options.userId) {
    // Mock auth token (in production, this would be a JWT)
    headers.set('authorization', `Bearer ${options.userId}:test@example.com`)
  }

  if (options.body) {
    headers.set('content-type', 'application/json')
  }

  return new Request(url, {
    method,
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  })
}

describe('Meals API', () => {
  const testUserId = 'test-user-123'
  const testUserId2 = 'test-user-456'
  let csrfToken: string

  beforeEach(async () => {
    // Generate CSRF token for tests
    csrfToken = generateCsrfToken(testUserId)

    // Clean up test data
    await db.meal.deleteMany({
      where: {
        OR: [{ userId: testUserId }, { userId: testUserId2 }]
      }
    })
  })

  describe('GET /api/meals', () => {
    it('should require authentication', async () => {
      const request = createRequest('GET', 'http://localhost:3000/api/meals')

      // Import route handler dynamically
      const { GET } = await import('@/app/api/meals/route')
      const response = await GET(request)

      expect(response.status).toBe(401)
      const data = await response.json()
      expect(data.error).toBe('Unauthorized')
    })

    it('should return user meals only', async () => {
      // Create meals for both users
      await db.meal.create({
        data: {
          userId: testUserId,
          name: 'User 1 Meal',
          type: 'lunch',
          calories: 500
        }
      })

      await db.meal.create({
        data: {
          userId: testUserId2,
          name: 'User 2 Meal',
          type: 'dinner',
          calories: 600
        }
      })

      const request = createRequest('GET', 'http://localhost:3000/api/meals', {
        userId: testUserId
      })

      const { GET } = await import('@/app/api/meals/route')
      const response = await GET(request)

      expect(response.status).toBe(200)
      const meals = await response.json()

      expect(meals).toHaveLength(1)
      expect(meals[0].name).toBe('User 1 Meal')
      expect(meals[0].userId).toBe(testUserId)
    })

    it('should filter meals by date', async () => {
      const today = new Date()
      const yesterday = new Date(today)
      yesterday.setDate(yesterday.getDate() - 1)

      await db.meal.create({
        data: {
          userId: testUserId,
          name: 'Today Meal',
          type: 'lunch',
          calories: 500,
          date: today
        }
      })

      await db.meal.create({
        data: {
          userId: testUserId,
          name: 'Yesterday Meal',
          type: 'dinner',
          calories: 600,
          date: yesterday
        }
      })

      const request = createRequest(
        'GET',
        `http://localhost:3000/api/meals?date=${today.toISOString()}`,
        { userId: testUserId }
      )

      const { GET } = await import('@/app/api/meals/route')
      const response = await GET(request)

      const meals = await response.json()
      expect(meals).toHaveLength(1)
      expect(meals[0].name).toBe('Today Meal')
    })
  })

  describe('POST /api/meals', () => {
    it('should require authentication', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        body: {
          userId: testUserId,
          name: 'Test Meal',
          type: 'lunch',
          calories: 500
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(401)
    })

    it('should require CSRF token', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        userId: testUserId,
        body: {
          userId: testUserId,
          name: 'Test Meal',
          type: 'lunch',
          calories: 500
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(403)
      const data = await response.json()
      expect(data.error).toBe('Invalid CSRF token')
    })

    it('should validate input', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        userId: testUserId,
        headers: { 'x-csrf-token': csrfToken },
        body: {
          userId: testUserId,
          name: '', // Invalid: empty name
          type: 'invalid-type', // Invalid type
          calories: -100 // Invalid: negative calories
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(400)
      const data = await response.json()
      expect(data.error).toBe('Validation failed')
      expect(data.details).toBeDefined()
    })

    it('should prevent creating meals for other users', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        userId: testUserId,
        headers: { 'x-csrf-token': csrfToken },
        body: {
          userId: testUserId2, // Trying to create for different user
          name: 'Test Meal',
          type: 'lunch',
          calories: 500
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(403)
      const data = await response.json()
      expect(data.error).toContain('Forbidden')
    })

    it('should create meal successfully with valid data', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        userId: testUserId,
        headers: { 'x-csrf-token': csrfToken },
        body: {
          userId: testUserId,
          name: 'Chicken Salad',
          type: 'lunch',
          calories: 450,
          protein: 35,
          carbs: 25,
          fat: 18,
          notes: 'Healthy lunch'
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(201)
      const meal = await response.json()

      expect(meal.name).toBe('Chicken Salad')
      expect(meal.type).toBe('lunch')
      expect(meal.calories).toBe(450)
      expect(meal.userId).toBe(testUserId)

      // Verify it was actually created in database
      const dbMeal = await db.meal.findUnique({ where: { id: meal.id } })
      expect(dbMeal).toBeDefined()
      expect(dbMeal?.name).toBe('Chicken Salad')
    })

    it('should sanitize input to prevent XSS', async () => {
      const request = createRequest('POST', 'http://localhost:3000/api/meals', {
        userId: testUserId,
        headers: { 'x-csrf-token': csrfToken },
        body: {
          userId: testUserId,
          name: '<script>alert("xss")</script>Salad',
          type: 'lunch',
          calories: 400,
          notes: 'onclick="alert(1)" malicious'
        }
      })

      const { POST } = await import('@/app/api/meals/route')
      const response = await POST(request)

      expect(response.status).toBe(201)
      const meal = await response.json()

      // Should not contain script tags or event handlers
      expect(meal.name).not.toContain('<script>')
      expect(meal.notes).not.toContain('onclick')
    })
  })

  describe('Rate Limiting', () => {
    it('should limit excessive requests', async () => {
      const requests: Promise<Response>[] = []

      // Make 65 requests (limit is 60/min)
      for (let i = 0; i < 65; i++) {
        const request = createRequest('GET', 'http://localhost:3000/api/meals', {
          userId: testUserId
        })

        const { GET } = await import('@/app/api/meals/route')
        requests.push(GET(request))
      }

      const responses = await Promise.all(requests)

      // Some should be rate limited
      const rateLimited = responses.filter((r) => r.status === 429)
      expect(rateLimited.length).toBeGreaterThan(0)
    })
  })
})
